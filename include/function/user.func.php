<?php/** 	Borno CMS*	All user function***//***	Admin User**/$role_id = 1 ;$role_name = "Admin" ;$user_capabilites = array();//automatic role is allucr_add_role($role_id , $role_name , $user_capabilites);/**	Site Manager**/$role_id = 2 ;$role_name = "Site Manager" ;$user_capabilites = array("manage_site"=>true,"manage_plugin"=>true,"manage_notify"=>true);//automatic role is allucr_add_role($role_id , $role_name , $user_capabilites);/**	Editor**/$role_id = 3 ;$role_name = "Editor" ;$user_capabilites = array(				"new_post"=>true,				"edit_all_post"=>true,				"edit_own_post"=>true,				"trash_all_post"=>true,				"trash_own_post"=>true,				"manage_doc"=>true,				"approved_post"=>true,				"add_comment"=>true,				"trash_own_post"=>true,				"approve_comment"=>true,				"manage_comment"=>true,				"trash_own_comment"=>true,				"trash_all_comment"=>true,				"delete_comment"=>true,				"restore_comment"=>true,				"delete_post"=>true,				"restore_post"=>true,				"add_category"=>true,				"edit_category"=>true,				"delete_category"=>true,				"upload_image"=>true,				"delete_own_image"=>true,				"delete_all_image"=>true																);//automatic role is allucr_add_role($role_id , $role_name , $user_capabilites);/**	User Manager**/$role_id = 4 ;$role_name = "User Manager" ;$user_capabilites = array(	'manage_user'=>true,	'add_user'=>true,	'edit_user'=>true,	'manage_user'=>true,	'delete_user'=>true);ucr_add_role($role_id , $role_name , $user_capabilites);/**	Author**/$role_id = 5 ;$role_name = "Author" ;$user_capabilites = array(	'new_post'=>true,	'edit_own_post'=>true,	'trash_own_post'=>true,	'add_comment'=>true,	'trash_own_comment'=>true,	'upload_image'=>true,	'delete_own_image'=>true);ucr_add_role($role_id , $role_name , $user_capabilites);/***	Subscriber **/$role_id = 6 ;$role_name = "Subscriber" ;$user_capabilites = array(	'add_comment'=>true,	'trash_own_comment'=>true);ucr_add_role($role_id , $role_name , $user_capabilites);/***	ZERO MAN **/$role_id = 7;$role_name = "ZERO" ;$user_capabilites = array();ucr_add_role($role_id , $role_name , $user_capabilites);function user_profile_link($user,$u=true){	if(is_exists_user($user)){			if(get_the_option('site_permalink')=='dynamic'){			if($u){				$output= '<a href="'.get_the_option('site_address').'/profile/'.the_user($user,'username').'/">';				$output.=  display_name($user).'</a>';			}			else{							$output=  get_the_option('site_address').'/profile/'.the_user($user,'username');			}				}else{							if($u){				$output=  '<a href="'.get_the_option('site_address').'/?profile='.the_user($user,'username').'">';				$output.=  display_name($user).'</a>';			}			else{							$output=  get_the_option('site_address').'/?profile='.the_user($user,'username');			}										}		return $output;		}	}/*  * * Add any user meta * add_user_meta($name,$value,$user_id) * $name= which filled you want to change , $value = the value ,$user_id= which user you want to change * */function add_user_meta($name,$value,$user_id){	//global $prefix_usermeta	global $prefix_usermeta;		//secure name	$name = mysqli_escape($name);		//secure value	$value = mysqli_escape($value);		//html value	$value = htmlspecialchars($value);		//secure user id	$user_id = mysqli_escape($user_id);		//browser info	$browser_info = $_SERVER['HTTP_USER_AGENT'];		//ip	$ip  = get_IP();// ip		//run query	borno_query("INSERT INTO $prefix_usermeta (`name`, `value`, `user_id`, `ip`, `browser`) VALUES ('$name', '$value ', '$user_id', '$ip', '$browser_info')");	}/***	Gravtar Function*	http://www.gravatar.com/*	Display user gravatar by email*/function get_gravatar( $email, $s , $d = 'mm', $r = 'g', $img = false, $atts = array() ) {    $url = 'http://www.gravatar.com/avatar/';	    $url .= md5( strtolower( trim( $email ) ) );	    $url .= "?s=$s&d=$d&r=$r";	    if ( $img ) {	        $url = '<img src="' . $url . '"';		        foreach ( $atts as $key => $val )		            $url .= ' ' . $key . '="' . $val . '"';			        $url .= ' />';		    }    return $url;}/***	Checking the user code**/function is_user_active_code_exists($code){	$query = borno_query("SELECT * FROM prefix_user WHERE active_key ='$code'");		return mysqli_num_rows($query);}/****	Adding a new user*****/function add_user($name ,$username , $email ,$password,$refer,$level,$account_active=1){	//reg info 		##reg info	$user_agent = $_SERVER['HTTP_USER_AGENT'];//agent		$user_ip = $_SERVER['REMOTE_ADDR'];//reg info		$reg_info = $user_agent." and  IP is - ".$user_ip;//ip				#name	$name = mysqli_escape($name);//secure name		$name = strip_tags($name); //strip tag form name	$name = htmlspecialchars($name);//html name			#username	$username = mysqli_escape($username);//secure name		$username = strip_tags($username);//strip tag form user name		$username = trim($username);//remove whitespace		$username = htmlspecialchars($username);//html username		#email		$email = mysqli_escape($email);//secure email		$email = strip_tags($email);//strip tag		$email = trim($email);//remove whitespace		#password	$password = mysqli_escape($password);		$password = strip_tags($password);		$password = trim($password);		#level	$level = mysqli_escape($level);		$level = strip_tags($level);		$level = trim($level);		$level = htmlspecialchars($level);		#account_active	$account_active = mysqli_escape($account_active);		$account_active = strip_tags($account_active);		$account_active = trim($account_active);		$account_active = htmlspecialchars($account_active);					##genarate a new active key 			$chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".	'0123456789``-=~!@#$%^&*()_+,./<>?;:[]{}\|oxyz';		$user_active_key =  md5(substr(str_shuffle($chars),0,8));											while(!is_user_active_code_exists($user_active_key)){								break 1;						}													#active key	$active_key = mysqli_escape($user_active_key);		$active_key = strip_tags($active_key);						#refet	$refer = trim($refer);		$refer = htmlspecialchars($refer);		$refer = strip_tags($refer);			#global table user	global $table_user;			#query	$qry = "INSERT INTO $table_user (`name`, `username`, `email`, `password`, `level`, `active_key`, `account_active`, `ref`, `reg_info`, `reg_time`) VALUES ('$name', '$username', '$email', '$password', '$level ', '$active_key', '$account_active', '$refer', '$reg_info', CURRENT_TIMESTAMP)";		#run query	borno_query($qry);		return $user_active_key;	}/**	The post user*	get the post_user***/function the_post_user($data){	if(isset($_GET['p'])){			$post_id = $_GET['p'];//post_id				global $prefix_contents ;//global prefix_content				global $prefix_users;//global prefix user				//query		$result = borno_query("SELECT * FROM $prefix_contents WHERE id='".mysqli_escape($post_id)."'");				//count		$count = mysqli_num_rows($result);				if($count==1){				//row				$row = mysqli_fetch_array($result);								//[post] user				$post_user= $row['user_id'];								//result				$result = borno_query("SELECT * FROM $prefix_users WHERE id='".mysqli_escape($post_user)."'");								//count				$count = mysqli_num_rows($result);									if($count==1){						//make user row table						$row = mysqli_fetch_array($result);												//get the data						$datas = $row[$data];												// return with data						return $datas;											}										}	}}/***	get the user by username**/function the_user_by_username($username , $data){				global $prefix_users;		$result = borno_query("SELECT * FROM $prefix_users WHERE username='".mysqli_escape($username)."'");		$count = mysqli_num_rows($result);					if($count==1){						$row = mysqli_fetch_array($result);						$datas = $row[ $data ];						return $datas;					}					}/**	User by post_id  / [p]*	get user information form and post*	**/function user_by_postid($post_id ,$data){	global 	$prefix_contents ;//global	global $prefix_users;//global		//query	$result = borno_query("SELECT * FROM $prefix_contents WHERE id='".mysqli_escape($post_id)."'");			//count	$count = mysqli_num_rows($result);		if($count==1){				$row = mysqli_fetch_array($result);//row						$post_user= $row['user_id'];//get user id form row						//query			$result = borno_query("SELECT * FROM $prefix_users WHERE id='".mysqli_escape($post_user)."'");						//count			$count = mysqli_num_rows($result);							if($count==1){									$row = mysqli_fetch_array($result);//make a row										$datas = $row[$data];//data for row										return $datas; // return with data									}				}	}/****	The user***/function the_user($user_id , $data){		global $prefix_users;		//query		$result = borno_query("SELECT * FROM $prefix_users WHERE id='".mysqli_escape($user_id)."'");				//count		$count = mysqli_num_rows($result);				if($count==1){						//make a row			$row = mysqli_fetch_array($result);						//get data form row			$datas = $row[$data];						//return with datas			return $datas; 		}}/**	Get user information form email*****/function the_user_by_email($email , $data){		global $prefix_users;				//query		$result = borno_query("SELECT * FROM $prefix_users WHERE email='".mysqli_escape($email)."'");				//count		$count = mysqli_num_rows($result);						if($count==1){					//make a row			$row = mysqli_fetch_array($result);						// get data form row			$datas = $row[$data];						// retun with data			return $datas;		}}/**	check if user exists*****/function user_exists($user_id){		global $prefix_users;				$result = borno_query("SELECT id FROM $prefix_users WHERE id='".mysqli_escape($user_id)."'");				$count = mysqli_num_rows($result);				if($count==1){					return true;			}									}/****	Check username exists or not***/function username_exists($username){	global $prefix_users;		//query	$result = borno_query("SELECT username FROM $prefix_users WHERE username='".mysqli_escape($username)."'");		//count	$count = mysqli_num_rows($result);		//condition	if($count==1){			return true;	}								}/****	Checking validate name and user name*****/function validate_name($str) {	/*	*	*	if numeric than return false	*/	if(is_numeric($str)){			return false;			}			//checking if number exists	 $c=  preg_match("/(1|2|3|4|5|6|7|8|9|10)/i", $str); 	 if(!$c==0){		return false;	 }	 	 		/*	*	if empty string return false	*	*/	if(empty($str)){			return false;			}		/*	*	each array entry is an special char allowed	*	besides the ones from ctype_alnum	*/		  $allowed = array(" ");	  if ( ctype_alnum( str_replace($allowed, '', $str ) ) ) {	  		return true;	  	  }   }function validate_username($str) {	/*	*	each array entry is an special char allowed	*	besides the ones from ctype_alnum	*/		$allowed = array(".", "-", "_");	if ( ctype_alnum( str_replace($allowed, '', $str ) ) ) {				return true;  	}   }/****	Update user****/function update_user($user_id,$field,$data){		/*		*	$user_id,$where,$data = user id , which field be change , chaged data		*/				global 	$table_user ;						#data				$data = htmlspecialchars($data);		$data = mysqli_escape($data);//secure data				#user				$user_id = mysqli_escape($user_id);		$user_id = htmlspecialchars($user_id);				#field 				$field = mysqli_escape($field);		$field = htmlspecialchars($field);		//query		borno_query("UPDATE $table_user SET `$field`='$data' WHERE id= '$user_id' ");				return the_user($user_id,$field);}/****	Get user form id ****/function user_by_id($user_id , $data){	if(filter_var($user_id, FILTER_VALIDATE_INT)){			$u_id =	mysqli_escape($user_id);//secure it				global $table_user;				$query =borno_query("SELECT * FROM $table_user WHERE id ='$u_id'");//query				$count=mysqli_num_rows($query);//count				if($count==1){					$row=mysqli_fetch_array($query);//row						$value = $row[$data];//get data form row						return $value;//return with value					}	}}/**	the_user_dispay_name*****/function the_user_dispay_name($username){			$e =  the_user_by_username($username,'name');//user email						if(!empty($e) or !$e==' ' or !$e==''){							return $e;						}			else{							return $username;			}			}																																																			/****	user display name******/function display_name($user_id){	global $prefix_users;	$result = borno_query("SELECT name,username FROM $prefix_users WHERE id='".mysqli_escape($user_id)."'"); //query			$count = mysqli_num_rows($result);		if($count==1){			$row = mysqli_fetch_array($result);				$name = trim($row[ 'name' ]);				$username =$row[ 'username' ];				if(isset($name) & !empty($name)){					return $name;					}		else{					return $username;		}						}					}/* * *	Is exist user (by userid) * */function is_exists_user($user_id){	if(filter_var($user_id, FILTER_VALIDATE_INT)){		global $prefix_user;		$query = borno_query("SELECT * FROM $prefix_user WHERE id ='$user_id'");		$count = mysqli_num_rows($query);		if($count==1){			return true;		}		else{			return false;		}	}	else{		return false;	}}///function social profilefunction social_profile($user_id,$type){global $prefix_usermeta;	if($type=='facebook' or $type=="fb"){	//facebook query		$fb_query = borno_query("SELECT * FROM $prefix_usermeta WHERE name = 'fb' AND user_id = '$user_id'");		//facebook action		$fb_count = mysqli_num_rows($fb_query);		if($fb_count==1){				$row = mysqli_fetch_array($fb_query);				//fb value				if(!empty($row['value'])){				return ('<a href="http://fb.com/'.$row['value'].'">Facebook</a>');				}		}	}		else if($type=='twitter' or $type=="twt"){	//twitter query		$twitter_query = borno_query("SELECT * FROM $prefix_usermeta WHERE name = 'twitter' AND user_id = '$user_id'");		//facebook action			$twitter_count = mysqli_num_rows($twitter_query);		if($twitter_count==1){				$row = mysqli_fetch_array($twitter_query);				//twitter username				if(!empty($row['value'])){					return '<a href="http://twitter.com/'.$row['value'].'">Twitter</a>';				}		}		}}/*****	The user link**/function  the_user_link($user){	global $url_profile;	//return '<a href="'.get_the_option('site_address').$url_profile.the_user($user , 'username').'">'.display_name($user).'</a>';return user_profile_link($user);}